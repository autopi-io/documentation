(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{121:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return i})),a.d(t,"metadata",(function(){return s})),a.d(t,"rightToc",(function(){return c})),a.d(t,"default",(function(){return b}));var o=a(2),n=a(6),r=(a(0),a(135)),i={id:"log-raw-can-messages",title:"Log raw CAN messages"},s={unversionedId:"guides/log-raw-can-messages",id:"guides/log-raw-can-messages",isDocsHomePage:!1,title:"Log raw CAN messages",description:"It is possible to listen for raw CAN data on the OBD port. There are a couple of",source:"@site/docs/guides/log_raw_can_messages.md",slug:"/guides/log-raw-can-messages",permalink:"/guides/log-raw-can-messages",version:"current",sidebar:"guidesSidebar",previous:{title:"How to export data from API",permalink:"/guides/how-to-export-data-from-api"},next:{title:"Setup your TMU DiY Edition",permalink:"/guides/setup-your-tmu-diy-edition"}},c=[{value:"Reading raw CAN data",id:"reading-raw-can-data",children:[{value:"<code>obd.monitor</code>",id:"obdmonitor",children:[]},{value:"<code>obd.export</code>",id:"obdexport",children:[]},{value:"<code>obd.import</code>",id:"obdimport",children:[]}]},{value:"Making sense of raw CAN data",id:"making-sense-of-raw-can-data",children:[]}],l={rightToc:c};function b(e){var t=e.components,i=Object(n.a)(e,["components"]);return Object(r.b)("wrapper",Object(o.a)({},l,i,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"It is possible to listen for raw CAN data on the OBD port. There are a couple of\nways that this can be accomplished - a slower python implementation and a faster, C implementation.\nIn this guide we will explore these two options and show the differences between the two. Later on\nwe will also explore how you can make sense of this raw data after it has been recorded."),Object(r.b)("p",null,"It is important to note that the monitoring tools can only be used as a part of an\n",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"/core/services/core-services-obd-manager"}),"OBD service")," workflow. We won't get into details about how\nyou can create a service worker in this guide, however we do have the\n",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"/guides/create-service-workers"}),"Create Service Workers")," guide which you can take a look at\nfor more details on how to create a worker and setup its workflow."),Object(r.b)("h2",{id:"reading-raw-can-data"},"Reading raw CAN data"),Object(r.b)("p",null,"Firstly, we will explore how to read the CAN messages that are visible on the CAN bus. These\nmessages will be raw, meaning that they will simply be binary data that is structured in a\nspecific way. Later on we will also explore how we can make sense of this raw CAN data by\ntransforming it into more readable format using DBC files that can automatically be generated\nfor your vehicle."),Object(r.b)("h3",{id:"obdmonitor"},Object(r.b)("inlineCode",{parentName:"h3"},"obd.monitor")),Object(r.b)("p",null,"The first and simplest way to monitor CAN data is with the\n",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"../core/services/core-services-obd-manager#monitor"}),Object(r.b)("inlineCode",{parentName:"a"},"obd.monitor"))," handler.\nThis handler will continuously listen on the OBD port looking for any data. This data\nwill then be transported down the workflow and there you will be able to use the different\nhooks to transform the data and finally return the data to the cloud, or save it to a file."),Object(r.b)("p",null,"An important note for this is that the ",Object(r.b)("inlineCode",{parentName:"p"},"obd.monitor")," implementation is very slow, as it is written\nin python, while ",Object(r.b)("inlineCode",{parentName:"p"},"obd.export"),", which we will explore in the next section is much faster, as it is\nrunning a separate process implemented in C. However, ",Object(r.b)("inlineCode",{parentName:"p"},"obd.monitor")," may be preferred, as it does\nallow the device to query for OBD data in between handler executions, while the ",Object(r.b)("inlineCode",{parentName:"p"},"obd.export"),"\nhandler does not. The image below shows an example setup for an ",Object(r.b)("inlineCode",{parentName:"p"},"obd.monitor")," worker."),Object(r.b)("p",null,Object(r.b)("img",{alt:"obd_monitor_worker",src:a(179).default})),Object(r.b)("h3",{id:"obdexport"},Object(r.b)("inlineCode",{parentName:"h3"},"obd.export")),Object(r.b)("p",null,Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"../core/services/core-services-obd-manager#export"}),Object(r.b)("inlineCode",{parentName:"a"},"obd.export"))," is basically\n",Object(r.b)("inlineCode",{parentName:"p"},"obd.monitor")," on steroids. It is much faster than it's python counterpart and doesn't clog up the\nAutoPi's resources as much. It starts up a separate process that does the monitoring,\ninstead of running as a part of the salt-minion process."),Object(r.b)("p",null,"This however means that the external process will have to attach to the OBD serial port\n(",Object(r.b)("inlineCode",{parentName:"p"},"/dev/serial0"),"), which means that it won't be possible to use ",Object(r.b)("inlineCode",{parentName:"p"},"obd")," commands to read CAN data.\nThis is because the ",Object(r.b)("inlineCode",{parentName:"p"},"obd.export")," handler needs to be sure to catch all CAN messages and it won't\nrelease the lock on the device."),Object(r.b)("p",null,"This handler is also a bit different than other handlers, as it does not pass any meaningful\ndata down the workflow, instead it saves the CAN messages to external files, which can then be\nread by ",Object(r.b)("inlineCode",{parentName:"p"},"obd.import"),". The files are located in ",Object(r.b)("inlineCode",{parentName:"p"},"/opt/autopi/obd/export/protocol_N")," where ",Object(r.b)("inlineCode",{parentName:"p"},"N")," is\nthe protocol number for your vehicle. In that directory you will be able to see a number of log\nfiles which contain the raw data that has been recorded by the handler. An example setup for a\nworkflow can be seen below."),Object(r.b)("p",null,Object(r.b)("img",{alt:"obd_export_worker",src:a(180).default})),Object(r.b)("h3",{id:"obdimport"},Object(r.b)("inlineCode",{parentName:"h3"},"obd.import")),Object(r.b)("p",null,"In order to actually be able to use the recorded data by ",Object(r.b)("inlineCode",{parentName:"p"},"obd.export")," within the AutoPi Core system,\nwe need to somehow import it. This is where\n",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"../core/services/core-services-obd-manager#import"}),Object(r.b)("inlineCode",{parentName:"a"},"obd.import"))," comes in -\nit reads the data that was written to the log files by ",Object(r.b)("inlineCode",{parentName:"p"},"obd.export")," and passes it down the workflow.\nIt is simply a workflow enabler, meaning that after you read the data, you can transform it in any\nway you'd like, execute any triggers and use a returner to save the data on the cloud or a local\nfile, just like with ",Object(r.b)("inlineCode",{parentName:"p"},"obd.monitor"),"."),Object(r.b)("p",null,Object(r.b)("img",{alt:"obd_import_worker",src:a(181).default})),Object(r.b)("h2",{id:"making-sense-of-raw-can-data"},"Making sense of raw CAN data"),Object(r.b)("p",null,"A key converter that can be used in the workflows described above is the\n",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"../core/services/core-services-obd-manager#can"}),"CAN converter"),". It is able\nto read the CAN database file that you have for your vehicle's protocol and transform the binary\ndata that has been passed to it into a more sensible format. Both ",Object(r.b)("inlineCode",{parentName:"p"},"obd.monitor")," and ",Object(r.b)("inlineCode",{parentName:"p"},"obd.import"),"\nuse the CAN converter in the workflows to sanitize the data."),Object(r.b)("p",null,"It is important to note however, that the DBC (CAN database) file would only be available if you have\nsetup CAN loggers for your device. In the ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://my.autopi.io"}),"AutoPi Cloud")," navigate to Car\nExplorer > Loggers where you'll be able to see all the loggers you currently have. They need to\nbe of type CAN. There are a few guides that you can take a look at to get them up an running:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://community.autopi.io/t/guide-how-to-setup-power-cycle-for-an-electric-vehicle/1668"}),"How to setup power cycle for an electric vehicle"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://community.autopi.io/t/how-to-import-custom-dbc-files/2091"}),"How to import custom DBC files")))))}b.isMDXComponent=!0},135:function(e,t,a){"use strict";a.d(t,"a",(function(){return d})),a.d(t,"b",(function(){return u}));var o=a(0),n=a.n(o);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,o,n=function(e,t){if(null==e)return{};var a,o,n={},r=Object.keys(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=n.a.createContext({}),b=function(e){var t=n.a.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},d=function(e){var t=b(e.components);return n.a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.a.createElement(n.a.Fragment,{},t)}},h=n.a.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,i=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),d=b(a),h=o,u=d["".concat(i,".").concat(h)]||d[h]||p[h]||r;return a?n.a.createElement(u,s(s({ref:t},l),{},{components:a})):n.a.createElement(u,s({ref:t},l))}));function u(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,i=new Array(r);i[0]=h;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var l=2;l<r;l++)i[l]=a[l];return n.a.createElement.apply(null,i)}return n.a.createElement.apply(null,a)}h.displayName="MDXCreateElement"},179:function(e,t,a){"use strict";a.r(t),t.default=a.p+"assets/images/obd_monitor_worker-3f496518499bfe36794ca5e8e2cff275.png"},180:function(e,t,a){"use strict";a.r(t),t.default=a.p+"assets/images/obd_export_worker-652bf565d5f705940197ebadd37e7730.png"},181:function(e,t,a){"use strict";a.r(t),t.default=a.p+"assets/images/obd_import_worker-a7a1b5e55120f7c38d072c86e7f8bf89.png"}}]);