(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{104:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return r})),n.d(t,"metadata",(function(){return s})),n.d(t,"rightToc",(function(){return l})),n.d(t,"default",(function(){return d}));var a=n(2),o=n(6),i=(n(0),n(166)),r={id:"send-device-data-to-own-server",title:"Send device data to own server"},s={unversionedId:"guides/api/send-device-data-to-own-server",id:"guides/api/send-device-data-to-own-server",isDocsHomePage:!1,title:"Send device data to own server",description:"Hey everyone!",source:"@site/docs/guides/api/send_device_data_to_own_server.md",slug:"/guides/api/send-device-data-to-own-server",permalink:"/guides/api/send-device-data-to-own-server",version:"current",sidebar:"guidesSidebar",previous:{title:"How to export data from API",permalink:"/guides/api/how-to-export-data-from-api"},next:{title:"Move a device to a dedicated environment",permalink:"/guides/business/move-to-dedicated-environment"}},l=[{value:"Set device&#39;s Cloud API Url",id:"set-devices-cloud-api-url",children:[]},{value:"Device communication",id:"device-communication",children:[]},{value:"Let&#39;s build a server",id:"lets-build-a-server",children:[]},{value:"Authentication",id:"authentication",children:[]},{value:"Final thoughts",id:"final-thoughts",children:[]},{value:"Full example code",id:"full-example-code",children:[]},{value:"Device data examples",id:"device-data-examples",children:[]}],c={rightToc:l};function d(e){var t=e.components,r=Object(o.a)(e,["components"]);return Object(i.b)("wrapper",Object(a.a)({},c,r,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,"Hey everyone!"),Object(i.b)("p",null,"Today, in this guide we will explore how you can setup your own server that accepts data from your AutoPi device. We won't get in too many\ndetails, but we will explore the very basics that are needed, namely:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"How to setup the device to send data to a server different from the default one"),Object(i.b)("li",{parentName:"ol"},"What format of the data to expect from the device"),Object(i.b)("li",{parentName:"ol"},"Code examples of a very basic REST endpoint (in NodeJS with the ExpressJS framework)")),Object(i.b)("p",null,"Since we will be building the server with NodeJS, this guide requires you to have a very basic familiarity with Javascript syntax, however it\nshouldn't be too hard to follow if you have used other programming languages. Also, you will need to have ",Object(i.b)("inlineCode",{parentName:"p"},"node")," and ",Object(i.b)("inlineCode",{parentName:"p"},"npm")," command line tools\ninstalled on your workstation. You can download the full NodeJS package from ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://nodejs.org/en/download/"}),"here"),"."),Object(i.b)("h2",{id:"set-devices-cloud-api-url"},"Set device's Cloud API Url"),Object(i.b)("p",null,"Firstly, we need to make sure that the device will connect to your own server. For this, we do have a very neat option that can\nbe changed from the ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://my.autopi.io"}),"AutoPi Cloud")," website. You need to navigate to Advanced > Settings > Cloud API where\nyou will be able to see a screen like the following:"),Object(i.b)("p",null,Object(i.b)("img",{alt:"cloud_api_uri",src:n(261).default})," "),Object(i.b)("p",null,"The Url field on that page points to where the device should send data. By default, obviously, it points to AutoPi's servers. You need to point\ninstead to a URL that is resolvable from your AutoPi device."),Object(i.b)("h2",{id:"device-communication"},"Device communication"),Object(i.b)("p",null,"Before we begin building our server, let's talk about the basic structure of the data that AutoPi devices send out. All data is sent in JSON format.\nMore specifically an array of JSON objects. Let's look at an example:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'[\n    // ...\n    {\n        "utc": "06:02:24",\n        "cog": 140.22,\n        "nsat": 9,\n        "alt": 34,\n        "@ts": "2020-09-03T12:38:24.374314Z",\n        "@t": "track.pos",\n        "sog": 0,\n        "loc": {\n            "lat": 57.02241,\n            "lon": 9.89919\n        }\n    },\n    // ...\n]\n')),Object(i.b)("p",null,"The most important pieces of information in this are the ",Object(i.b)("inlineCode",{parentName:"p"},"@t")," and ",Object(i.b)("inlineCode",{parentName:"p"},"@ts")," fields. They are the type and timestamp fields. The rest of the fields are depending\non what type of data is being sent. Due to this, you are also able to decern what data fields you will receive based on the type that is provided. At the\n",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"#device-data-examples"}),"end")," we will provide you with more example data sets."),Object(i.b)("p",null,"It is also important to mention what the device will do when you send back a response. 2xx response codes like 200 OK will notify the device that the data\nhas been saved properly and in turn the device will delete the data that was just sent. 4xx and 5xx response codes will let the device know that the\ndata wasn't correctly saved, so the device will try sending the data again later."),Object(i.b)("h2",{id:"lets-build-a-server"},"Let's build a server"),Object(i.b)("p",null,"As mentioned in the introduction, this guide we will be using NodeJS with the ExpressJS framework. Although we are using NodeJS in this guide,\nthis is entirely possible to do with any other language that has such capabilities, like Python, .NET, Java and so on."),Object(i.b)("p",null,"Before we begin writing any code, we need to bootstrap our work environment. Let's begin by setting up an npm environment:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"npm init\n")),Object(i.b)("p",null,"This command will ask you for some details about the new environment that you will be working in. You don't need to be too specific.\nAfter you have initialized your environment, we should install the express framework:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"npm install --save express\n")),Object(i.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(i.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(i.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(i.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"By default, with version npm 5.0+ npm install adds the module to the dependencies list in the package.json file; with earlier versions of npm,\nyou must specify the --save option explicitly. Then, afterwards, running npm install in the app directory will automatically install modules\nin the dependencies list."))),Object(i.b)("p",null,"Now that we have it installed, we can finally start writing code by creating an ",Object(i.b)("inlineCode",{parentName:"p"},"index.js")," file, or whatever you set the entry point to\nbe named, in the root directory, or if you'd prefer, create a directory where you will keep your source code and create it there."),Object(i.b)("p",null,"Firstly, we start off by creating an express application:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-javascript"}),"// index.js\n\nconst express = require('express');\nconst app = express();\n")),Object(i.b)("p",null,"The express application object will be used to setup the configuration for our API routes. We can use the ",Object(i.b)("inlineCode",{parentName:"p"},"get"),", ",Object(i.b)("inlineCode",{parentName:"p"},"post"),", ",Object(i.b)("inlineCode",{parentName:"p"},"put")," and ",Object(i.b)("inlineCode",{parentName:"p"},"delete"),"\nmethods of the ",Object(i.b)("inlineCode",{parentName:"p"},"app")," object to build up the routes which will be available on your server. Let's look:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-javascript"}),"// index.js\n\napp.get('/', (req, res) => {\n    res.send('Hello world!');\n});\n")),Object(i.b)("p",null,"The above example simply allows clients to make a ",Object(i.b)("inlineCode",{parentName:"p"},"GET")," request to your server and will respond with a 'Hello world!' message. Express\nautomatically sets the response code to 200 OK with the ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://expressjs.com/en/4x/api.html#res.send"}),Object(i.b)("inlineCode",{parentName:"a"},"send"))," method unless specified\notherwise. Now that we have our first API endpoint specified, it is time that we started the server up:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-javascript"}),"// index.js\n\nconst port = 8000;\napp.listen(port, () => {\n    console.log(`Example express application listening on port ${port}`);\n});\n")),Object(i.b)("p",null,"With this, we are ready to test out our application. Run ",Object(i.b)("inlineCode",{parentName:"p"},"node index.js")," in your command line and after you see the console message appear,\nnavigate your browser to ",Object(i.b)("inlineCode",{parentName:"p"},"localhost:8000"),". You should be able to see the 'Hello world!' message appear on your screen."),Object(i.b)("p",null,"Let's now work with a more specific example. As expected, your device will be trying to send data over to your server. This data will be\nsent through ",Object(i.b)("inlineCode",{parentName:"p"},"POST")," requests, which means that we will need to change the method which the server recognizes and extract the data from the\nrequest body. Since the device will send data over in JSON format, you will also need to use a body parsing middleware such as\n",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://expressjs.com/en/4x/api.html#express.json"}),Object(i.b)("inlineCode",{parentName:"a"},"express.json()")),". Make sure to add the new code before you call the ",Object(i.b)("inlineCode",{parentName:"p"},"listen"),"\nmethod on your express application."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-javascript"}),"// index.js\n\nconst express = require('express');\nconst app = require('app');\n\napp.use(express.json());\n\napp.post('/', (req, res) => {\n    // this is the data that was sent by the device\n    const data = req.body;\n\n    // work with data in some way\n    console.log(data);\n\n    res.response(200).end();\n});\n\napp.listen(/* ... */);\n")),Object(i.b)("h2",{id:"authentication"},"Authentication"),Object(i.b)("p",null,"Of course, it would be nice if there is some type of authentication happening, instead of letting everyone send data over to your server.\nYou can do that by adding a middleware function that will authenticate based on the token that is being sent by the device. You can find the token\nyour device uses by navigating over to ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://my.autopi.io"}),"AutoPi Cloud")," > Advanced > Settings > Cloud API. One of the first fields there should be the\nAuth Token field. The token will be sent in the ",Object(i.b)("inlineCode",{parentName:"p"},"Authorization")," HTTP header in the following format:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"Authorization: Bearer AUTH_TOKEN\n")),Object(i.b)("p",null,"Now that we know what the token is, we can write a middleware function that we can later use to authorize client requests. We can get the ",Object(i.b)("inlineCode",{parentName:"p"},"Authorization"),"\nheader's data by using the ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://expressjs.com/en/4x/api.html#req.get"}),Object(i.b)("inlineCode",{parentName:"a"},"req.get()"))," method inside the middleware:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-javascript"}),"// authenticate.js\n\nmodule.exports = function authenticate(req, res, next) {\n    const authorizedToken = \"SOME TOKEN PASTED IN HERE OR SOMEWHERE ELSE\";\n    const token = req.get('Authorization');\n    \n    if token !== `Bearer ${authorizedToken}` {\n        // token is invalid, bail out\n        res.status(401).end();\n        return\n    }\n\n    // token is valid, call next middleware function\n    next();\n}\n")),Object(i.b)("p",null,"One thing that we can notice in the ",Object(i.b)("inlineCode",{parentName:"p"},"authenticate")," function is that it accepts the same arguments as the function that we created for the router,\n",Object(i.b)("inlineCode",{parentName:"p"},"req")," and ",Object(i.b)("inlineCode",{parentName:"p"},"res"),". Those are the same request and response objects that are passed on all middleware functions with data for the specific request\nthat is being processed at the time. The ",Object(i.b)("inlineCode",{parentName:"p"},"next")," parameter is an extra parameter that is also passed to each middleware function. Its purpose is\nto pass the flow to the next middleware function. If the ",Object(i.b)("inlineCode",{parentName:"p"},"next")," function is called without any arguments, the next middleware function will be\ncalled, if it is called with any argument, for example a string or an ",Object(i.b)("inlineCode",{parentName:"p"},"Error")," object, it will return a 500 status code to the users and finally,\nif it isn't called at all the flow will stop at the current middleware function. More information on middleware functions can be found\n",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://expressjs.com/en/guide/writing-middleware.html"}),"here"),"."),Object(i.b)("p",null,"After implementing ",Object(i.b)("inlineCode",{parentName:"p"},"authenticate"),", you can attach it to the already existing router:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-javascript"}),"// index.js\n\nconst express = require('express');\nconst app = require('app');\n\n// import the authenticate function\nconst authenticate = require('./authenticate.js');\n\napp.use(express.json());\n\n// add it as an argument to the post method, right before the actual receiver of the data\napp.post('/', authenticate, (req, res) => {\n    const data = req.body;\n    // work with data in some way\n    res.response(200).end();\n});\n\napp.listen(/* ... */);\n")),Object(i.b)("p",null,"With all this setup, your server should be ready to accept data from your device. Of course, this code example is not going to store any of the data\nthat is being sent from the device, but you are able to manipulate, store or do anything else you'd like with your data the way you prefer to."),Object(i.b)("h2",{id:"final-thoughts"},"Final thoughts"),Object(i.b)("p",null,"It should be fairly simple to get a server up and running to accept data from any AutoPi device. This guide went into brief details on how to implement such a\nserver in NodeJS, however implementing a REST API server is very simple with any other modern programming language. As usual, if you have any questions in regard\nto this, feel free to contact our support team on ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"mailto:support@autopi.io"}),"support@autopi.io")," and they will be more than happy to give you guidance."),Object(i.b)("h2",{id:"full-example-code"},"Full example code"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-javascript"}),"// authenticate.js\n\nmodule.exports = function authenticate(req, res, next) {\n    const authorizedToken = \"SOME TOKEN PASTED IN HERE OR SOMEWHERE ELSE\";\n    const token = req.get('Authorization');\n\n    if token !== `Bearer ${authorizedToken}` {\n        // token is invalid, bail out\n        res.status(401).end();\n        return\n    }\n\n    // token is valid, call next middleware function\n    next();\n}\n")),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-javascript"}),"// index.js\n\nconst express = require('express');\nconst app = require('app');\nconst authenticate = require('./authenticate.js');\n\nconst port = 8000;\n\napp.use(express.json());\n\napp.post('/', authenticate, (req, res) => {\n    const data = req.body;\n\n    // work with data in some way\n    console.log(data);\n    res.response(200).end();\n});\n\napp.listen(port, () => {\n    console.log(`Example AutoPi clone is running on ${port}`);\n});\n")),Object(i.b)("h2",{id:"device-data-examples"},"Device data examples"),Object(i.b)("p",null,"Following are some example data sets that AutoPi devices send regularly."),Object(i.b)("h4",{id:"gps-position"},"GPS position"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'[\n    // ...\n    {\n        "utc": "06:02:24",\n        "cog": 140.22,\n        "nsat": 9,\n        "alt": 34,\n        "@ts": "2020-09-03T12:38:24.374314Z",\n        "@t": "track.pos",\n        "sog": 0,\n        "loc": {\n            "lat": 57.02241,\n            "lon": 9.89919\n        }\n    },\n    // ...\n]\n')),Object(i.b)("h4",{id:"obd-voltage-level"},"OBD voltage level"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'[\n    {\n        "voltage": 15.4,\n        "@ts": "2021-02-24T09:03:09.310362Z",\n        "state": "overcharging",\n        "level": 100,\n        "@t": "obd.bat",\n    },\n    // ...\n]\n')),Object(i.b)("h4",{id:"sim-card-data-usage"},"SIM card data usage"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'[\n    {\n        "sent": 2695,\n        "@t": "ec2x.data_usage",\n        "recv": 4742,\n        "@ts": "2021-02-24T09:03:02.570313Z",\n    },\n    // ...\n]\n')),Object(i.b)("h4",{id:"events"},"Events"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'[\n    {\n        "@tag": "system/minion/online",\n        "@t": "event.system.minion",\n        "@ts": "2021-02-24T09:02:12.192479Z",\n    },\n    // ...\n]\n')),Object(i.b)("p",null,"Note that there are some events that do send out some data along, for example:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'[\n    {\n        "trigger": "stn",\n        "awaken": "sleeping",\n        "@ts": "2021-02-24T09:02:02.532461Z",\n        "@tag": "system/power/on",\n        "@t": "event.system.power",\n    },\n    // ...\n]\n')))}d.isMDXComponent=!0},166:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return h}));var a=n(0),o=n.n(a);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=o.a.createContext({}),d=function(e){var t=o.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=d(e.components);return o.a.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},b=o.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,r=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=d(n),b=a,h=p["".concat(r,".").concat(b)]||p[b]||u[b]||i;return n?o.a.createElement(h,s(s({ref:t},c),{},{components:n})):o.a.createElement(h,s({ref:t},c))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,r=new Array(i);r[0]=b;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,r[1]=s;for(var c=2;c<i;c++)r[c]=n[c];return o.a.createElement.apply(null,r)}return o.a.createElement.apply(null,n)}b.displayName="MDXCreateElement"},261:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/cloud_api_url-e7293ca6382ad9af903966a7f906cdce.png"}}]);