"use strict";(self.webpackChunkdocumentation_2=self.webpackChunkdocumentation_2||[]).push([[3438],{4429:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/create_worker_completed-babf7eb9856d1ebfd69aadc8949cf5f1.png"},28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>a});var r=n(96540);const o={},s=r.createContext(o);function i(e){const t=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(s.Provider,{value:t},e.children)}},41003:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/worker_list-9fea8776e207e67ecd556c950558cec6.png"},47886:(e,t,n)=>{n.d(t,{A:()=>s});n(96540);var r=n(74848);const o={mini:{name:"Mini",image:"/img/hardware/autopi_mini/AutoPi_Mini_5_Top_right.png"},cm4:{name:"TMU CM4",image:"/img/hardware/autopi_tmu_cm4/TMU_Floating_Topside_V1_scaled.png"},pro:{name:"CAN-FD Pro",image:"/img/hardware/autopi_canfd_pro/canfd_pro_trans.png"}};function s(e){let{supported:t}=e;return t?.length?(0,r.jsxs)("div",{style:{padding:"1rem",marginBottom:"1.5rem"},children:[(0,r.jsx)("strong",{children:"This guide is applicable to the following device/ devices:"}),(0,r.jsx)("div",{style:{display:"flex",gap:"1.5rem",marginTop:"0.5rem"},children:t.map((e=>{const t=o[e];return(0,r.jsxs)("div",{style:{textAlign:"center"},children:[(0,r.jsx)("img",{src:t.image,alt:t.name,style:{height:"60px",marginBottom:"0.25rem"}}),(0,r.jsx)("div",{children:t.name})]},e)}))})]}):null}},58162:(e,t,n)=>{n.d(t,{A:()=>i});n(96540);const r="homeGrid_MM9h",o="cardGrid_IPp8";var s=n(74848);const i=e=>{let{children:t,home:n=!1}=e;return(0,s.jsx)("div",{className:n?r:o,children:t})}},64128:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>h,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"cloud/device_management/services/create-custom-workers","title":"Create Custom Workers","description":"---","source":"@site/docs/cloud/device_management/services/create_custom_workers.md","sourceDirName":"cloud/device_management/services","slug":"/cloud/device_management/services/create-custom-workers","permalink":"/cloud/device_management/services/create-custom-workers","draft":false,"unlisted":false,"editUrl":"https://github.com/autopi-io/documentation/edit/master/docs/cloud/device_management/services/create_custom_workers.md","tags":[],"version":"current","frontMatter":{"id":"create-custom-workers","title":"Create Custom Workers","supportedDevices":["cm4","pro"]},"sidebar":"sidebar","previous":{"title":"Create Custom Triggers","permalink":"/cloud/device_management/services/create-custom-triggers"},"next":{"title":"Jobs","permalink":"/cloud/device_management/cloud-jobs"}}');var o=n(74848),s=n(28453),i=(n(58162),n(47886));const a={id:"create-custom-workers",title:"Create Custom Workers",supportedDevices:["cm4","pro"]},l=void 0,h={},c=[{value:"Workers",id:"workers",level:2},{value:"Let&#39;s Create a Worker",id:"lets-create-a-worker",level:3},{value:"Workflows",id:"workflows",level:3},{value:"Hooks",id:"hooks",level:3},{value:"Troubleshooting Your Service",id:"troubleshooting-your-service",level:3},{value:"My service doesn&#39;t start / I dont see any logs from my service",id:"my-service-doesnt-start--i-dont-see-any-logs-from-my-service",level:4},{value:"Conclusion",id:"conclusion",level:2}];function d(e){const t={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(i.A,{supported:a.supportedDevices}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.p,{children:"In this guide we are going to take a look at how to create workers for any service that is\navailable, be it a default service like the OBD manager or a custom one that you've made for\nyourselves. First off we're going to explore what can workers be used for and later on in the guide\nwe're going to go through creating an example worker that is going to fetch OBD data and save that\ndata to a file. Let's get started!"}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Service list",src:n(94860).A+"",width:"1823",height:"1244"})}),"\n",(0,o.jsx)(t.h2,{id:"workers",children:"Workers"}),"\n",(0,o.jsxs)(t.p,{children:["Now, the real deal - workers. Workers are simply a process that is going to be executed by a\nmanager in a specific ",(0,o.jsx)(t.a,{href:"/core/services/",children:"workflow"})," that is going to eventually yield a\ndesired output. Workflows are a number of steps that are going to be executed in order to create\nthat desired output:"]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Worker list",src:n(41003).A+"",width:"1823",height:"1244"})}),"\n",(0,o.jsx)(t.h3,{id:"lets-create-a-worker",children:"Let's Create a Worker"}),"\n",(0,o.jsx)(t.p,{children:"First off, you'll need to decide which manager to use. That really depends on the use case you\nhave. For example, if you would like to read OBD data, the obd_manager would make the most sense.\nIf on the other hand you would like to execute some AT command that isn't implemented by default,\nthe ec2x_manager is the one you'd be looking at."}),"\n",(0,o.jsx)(t.p,{children:"For the purposes of this guide, we will create a worker inside the obd_manager that will be\nfetching some data. We will navigate to the services page (Device > Services) and select the\nobd_manager entry on the screen."}),"\n",(0,o.jsx)(t.p,{children:"The new page that opens up is the home page for the obd_manager where all of its workers reside.\nWe will create a new worker now. Click on the '+ Create' button to open up the creation window."}),"\n",(0,o.jsx)(t.p,{children:"You'll be presented with the following window:"}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Create empty worker",src:n(97577).A+"",width:"1222",height:"719"})}),"\n",(0,o.jsx)(t.p,{children:"Let's now get familiar with the interface. There are a few fields that need filling out and then\nwe will move on to the workflows:"}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Name"}),": The name of the worker. This is just for recognizability of the worker."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Delay"}),": This is the delay before the initial start of execution of the worker. This means\nthat the worker will wait ",(0,o.jsx)(t.em,{children:"X"})," amount of seconds before initiating the first loop."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Interval"}),": This is the interval between each loop of the worker. As we'll see below, you are\nable to set the worker to execute multiple times (which is why they're so useful). The interval\nwill be the time that it takes between each execution."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Loop"}),": This is the amount of times the worker will execute within a power cycle of the ",(0,o.jsx)(t.a,{href:"https://www.autopi.io",children:"AutoPi"}),"\ndevice. You can set this to the following values:"]}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.em,{children:"less than 0"}),": The worker will loop forever and execute the workflow every time"]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.em,{children:"0 or more"}),": The worker will loop the amount of times specified and then stop. This can be\nused if you want the worker to do a specified amount of work and then stop working. The total\namount of executions that will occur are equal to the loop count + 1."]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Order"}),": This is the order that the workers are going to be executed in. This is a more\n'global' field, meaning that it will affect the execution of the rest of the workers in this\nservice as well. The lowest ordered worker will execute first and then go up from there."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Transactional"}),": This option is useful if there are multiple workflows on the same worker. If\none of the workflows fails, if transactional is enabled, then all the rest of the workflows won't\nbe executed. On the other hand, if it isn't enabled, the rest of the workflows will still be\nexecuted."]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(t.h3,{id:"workflows",children:"Workflows"}),"\n",(0,o.jsx)(t.p,{children:"Now that we've gone through the basic options, let's take a look at the possibilities for\nworkflows. Creating a workflow adds a new row on the table below. This is the basic representation\nof a workflow. The columns in the table are as follows:"}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Handler"})," - handlers are the first step in the workflow. They will communicate with the\ndevice's hardware and produce the initial output."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"args"})," - the arguments that are to be passed to the handler."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"kwargs"})," - the key word arguments that are to be passed to the handler."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Converter"})," - they transform the data to another, usually more usable, form."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Trigger"})," - this is usually the code that decides whether to do something based on the result\nof the handler, for example, ",(0,o.jsx)(t.a,{href:"/cloud/device_management/triggers/a-guide-to-triggers/",children:"making a beep sound from the device"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Filter"})," - filters are responsible for deciding whether the data that is currently being\nmanipulated is significant or not. They can stop the flow of execution if they return something\nthat is considered ",(0,o.jsx)(t.a,{href:"https://stackoverflow.com/questions/39983695/what-is-truthy-and-falsy-how-is-it-different-from-true-and-false",children:"falsy"})," -\nfor example a value of ",(0,o.jsx)(t.code,{children:"False"}),", ",(0,o.jsx)(t.code,{children:"None"}),", an empty string, and so on."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Enricher"})," - enrichers.. well.. enrich the data. They add additional data, possibly by\ncomputing the result."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Returner"})," - returners are responsible for returning the result somewhere. For example,\n",(0,o.jsx)(t.a,{href:"/cloud/device_management/services/create-custom-returners/",children:"saving the result on a file"}),"\nor sending it over the internet to some cloud solution. A prime example for a returner is the\n",(0,o.jsx)(t.a,{href:"https://www.autopi.io/software-platform/cloud-management",children:"Cloud"})," returner that is responsible for saving the data on ",(0,o.jsx)(t.a,{href:"https://my.autopi.io/",children:"my.autopi.io"}),"."]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["All of the above (except for args and kwargs) are also called ",(0,o.jsx)(t.em,{children:"hooks"}),". We will look into them in\nthe next section."]}),"\n",(0,o.jsxs)(t.p,{children:["Different services have different defaults handlers. The best place to take a look at those\nhandlers is ",(0,o.jsx)(t.a,{href:"/core/services/",children:"the services page"}),". Since the idea we're going for in this\nguide is to invoke continuous OBD query commands, we're going to be using the\n",(0,o.jsx)(t.a,{href:"/core/services/core-services-obd-manager/#query",children:"query"})," handler."]}),"\n",(0,o.jsx)(t.p,{children:"The arguments (args) and key-word arguments (kwargs) are specified in JSON format (this means\ndouble quotes instead of single quotes, it took me a while to figure that out the other day). We\nwant to read out the fuel level every 10 seconds and record that data, so we will specify the\nfollowing arguments:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-json",children:'[ "FUEL_LEVEL" ]\n'})}),"\n",(0,o.jsx)(t.p,{children:"The key-word arguments aren't essential for the worker to work, however they give more control over\nhow it'll operate, so we'll specify the following kwargs:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-json",children:'{\n    "mode": 1,\n    "force": true\n}\n'})}),"\n",(0,o.jsxs)(t.p,{children:["Now we've got the first part of a workflow going. From here on out, everything else is optional\ndepending on your needs. Most of you would want to have some way of saving the data however, for\nwhich you can use a returner. You can view a guide about that ",(0,o.jsx)(t.a,{href:"/cloud/device_management/services/create-custom-returners/",children:"here"}),".\nHere's the final result:"]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Create worker completed",src:n(4429).A+"",width:"1213",height:"652"})}),"\n",(0,o.jsx)(t.p,{children:"The last thing you need to do is to hit Save and let the device sync up with the new changes. After\na service restart, the device should be executing your new service worker."}),"\n",(0,o.jsx)(t.h3,{id:"hooks",children:"Hooks"}),"\n",(0,o.jsx)(t.p,{children:"You can create your own custom hooks by creating a new custom module (Device > Custom Code) with\nan execution type, but you have to register them to each individual service through the Hooks tab.\nEach hook needs to have this specific signature:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:"def some_function_name(result):\n    # work with result and return some manipulated value\n    return value\n"})}),"\n",(0,o.jsxs)(t.p,{children:["The important part is that the function receives some result and returns some value. Based on the\noutput of each hook the workflow might be interrupted. If falsy values are returned at a specific\npoint in the workflow, the rest of the workflow will stop. ",(0,o.jsx)(t.strong,{children:"This isn't the case"})," with triggers -\nthey will always execute, as the logic there might be very valuable to be executed even if there is\nan interruption. Even in the case of a thrown exception the trigger will still execute."]}),"\n",(0,o.jsx)(t.h3,{id:"troubleshooting-your-service",children:"Troubleshooting Your Service"}),"\n",(0,o.jsx)(t.h4,{id:"my-service-doesnt-start--i-dont-see-any-logs-from-my-service",children:"My service doesn't start / I dont see any logs from my service"}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["Check that the service is enabled in the ",(0,o.jsx)(t.a,{href:"https://www.autopi.io/software-platform/cloud-management",children:"Cloud"}),", and check that it is part of the engines file in\n",(0,o.jsx)(t.code,{children:"/etc/salt/minion.d/engines.conf"})]}),"\n",(0,o.jsx)(t.li,{children:"Check that the associated custom module has valid code"}),"\n",(0,o.jsx)(t.li,{children:"Turn on debug logging on the device (In advanced settings), and restart the salt-minion, and\nthen look for errors."}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:"You can use the following command to grep for the specific service:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"sudo tail -f /var/log/salt/minion | grep service_name\n"})}),"\n",(0,o.jsx)(t.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,o.jsxs)(t.p,{children:["As a closer - workers are extremely powerful if used correctly. They can execute continuously or a\nset amount of times. Workflows within the worker can be set up so that the desired outcome is\nreached without having to write complicated custom code. Use them to your advantage whenever you\nwant to communicate something with the hardware components of the ",(0,o.jsx)(t.a,{href:"https://www.autopi.io",children:"AutoPi"})," or with your car directly."]})]})}function u(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},94860:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/service_list-4a3c4dcc479987f4db49b227ea1d4fb9.png"},97577:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/create_worker_empty-71d8c90e2c58922cd790439ee9ba9770.png"}}]);