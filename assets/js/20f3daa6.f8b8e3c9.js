(self.webpackChunkdocumentation_2=self.webpackChunkdocumentation_2||[]).push([[4795],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return u},kt:function(){return m}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=r.createContext({}),l=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=l(e.components);return r.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,c=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=l(n),m=a,g=d["".concat(c,".").concat(m)]||d[m]||p[m]||o;return n?r.createElement(g,i(i({ref:t},u),{},{components:n})):r.createElement(g,i({ref:t},u))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var l=2;l<o;l++)i[l]=n[l];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},2943:function(e,t,n){"use strict";n.d(t,{$:function(){return a}});var r=n(7294),a=function(e){var t=e.title,n=e.url;return r.createElement(r.Fragment,null,r.createElement("h2",null,"Discussion"),r.createElement("p",null,"If you'd like to discuss this topic with us or other fellow community members, you can do so on our community page dedicated for this guide: ",r.createElement("a",{href:n},t),"."),r.createElement("p",null,"You can also write us an email on ",r.createElement("a",{href:"mailto:support@autopi.io"},"support@autopi.io"),". We usually respond back in 24 hours on working days."))}},9260:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return c},contentTitle:function(){return l},metadata:function(){return u},toc:function(){return p},default:function(){return m}});var r=n(2122),a=n(9756),o=(n(7294),n(3905)),i=n(2943),s=["components"],c={id:"create-custom-service-triggers",title:"Create Custom Service Triggers"},l=void 0,u={unversionedId:"guides/services/create-custom-service-triggers",id:"guides/services/create-custom-service-triggers",isDocsHomePage:!1,title:"Create Custom Service Triggers",description:"In this guide we will explore how you can create a custom trigger for your AutoPi service. The",source:"@site/docs/guides/services/create_custom_service_triggers.mdx",sourceDirName:"guides/services",slug:"/guides/services/create-custom-service-triggers",permalink:"/guides/services/create-custom-service-triggers",version:"current",frontMatter:{id:"create-custom-service-triggers",title:"Create Custom Service Triggers"},sidebar:"guidesSidebar",previous:{title:"Create Custom Service Returners",permalink:"/guides/services/create-custom-service-returners"},next:{title:"4G internet setup troubleshooting",permalink:"/guides/4g-internet-setup-troubleshooting"}},p=[{value:"Want an Event Instead of a Beep?",id:"want-an-event-instead-of-a-beep",children:[]}],d={toc:p};function m(e){var t=e.components,c=(0,a.Z)(e,s);return(0,o.kt)("wrapper",(0,r.Z)({},d,c,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"In this guide we will explore how you can create a custom trigger for your AutoPi service. The\nexample that we will look at is a trigger that will play a beeping sound when the vehicle's speed\nis 50km/h or more. Let's dive straight in."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Let's start by creating a custom code module with the name ",(0,o.kt)("em",{parentName:"p"},"my_triggers")," of type ",(0,o.kt)("em",{parentName:"p"},"Execution"),". We\ncan do that by going over to ",(0,o.kt)("strong",{parentName:"p"},"Advanced")," > ",(0,o.kt)("strong",{parentName:"p"},"Custom Code"),":"),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("img",{alt:"Editing custom code",src:n(9744).Z})," "),(0,o.kt)("p",{parentName:"li"},"Here is the code in plain text for easy copy and paste:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-python"},'import logging\n\nfrom messaging import extract_error_from\n\nlog = logging.getLogger(__name__)\n\ndef speed_warning_beep(result):\n    """\n    Trigger that will play a warning beep sound when vehicle speed exceeds value of 50.\n    """\n\n    # Check for error result\n    error = extract_error_from(result)\n    if error:\n        log.warning("Speed warning beep trigger got error result: {:}".format(result))\n\n        return\n\n    # Check if speed value is above threshold\n    if result.get("value", 0) >= 50:\n\n        # Only play sound when threshold value is exceeded\n        if not __context__.get("speed_warning_beep", False):\n            __salt__["cmd.run"]("aplay /opt/autopi/audio/sound/beep.wav")\n\n            # Set flag in context\n            __context__["speed_warning_beep"] = True\n\n    # Speed value is below threshold\n    else:\n\n        # Reset flag in context\n        __context__["speed_warning_beep"] = False\n')),(0,o.kt)("p",{parentName:"li"},"To quickly run through the code, this code creates a function that will check if the result\npassed to it has a ",(0,o.kt)("inlineCode",{parentName:"p"},"value")," key that is equal to or more than 50. Once that condition is met, it\nwill make sure that the vehicle isn't already in that state through the context (if the vehicle\nis continuously above 50km/h we won't play the beeping sound continuously) and if it isn't it'll\nplay the beeping sound. Once the above or equal to condition is no longer met, we reset the\ncontext."),(0,o.kt)("p",{parentName:"li"},"Now, let's synchronise the changes to the device by clicking the ",(0,o.kt)("strong",{parentName:"p"},"Sync")," button. If the device\nis offline the changes will automatically be synchronised on next start-up.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Next, we need to register that trigger in the service that it'll be used. For this guide, we\nneed to register it in the OBD service named ",(0,o.kt)("strong",{parentName:"p"},"obd_manager"),". Go to ",(0,o.kt)("strong",{parentName:"p"},"Advanced")," > ",(0,o.kt)("strong",{parentName:"p"},"Services")," >\n",(0,o.kt)("strong",{parentName:"p"},"obd_manager")," > ",(0,o.kt)("strong",{parentName:"p"},"Hooks")," > ",(0,o.kt)("strong",{parentName:"p"},"Create"),":"),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("img",{alt:"Creating a custom hook",src:n(1743).Z})," ")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"We now need to use the newly registered trigger hook by adding it to a workflow in a worker.\nGo to ",(0,o.kt)("strong",{parentName:"p"},"Advanced")," > ",(0,o.kt)("strong",{parentName:"p"},"Services")," > ",(0,o.kt)("strong",{parentName:"p"},"obd_manager")," > ",(0,o.kt)("strong",{parentName:"p"},"Workers")," > ",(0,o.kt)("strong",{parentName:"p"},"Create"),":"),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("img",{alt:"Creating a new worker",src:n(1115).Z})," "),(0,o.kt)("p",{parentName:"li"},"When the above changes have been successfully synchronised to your device, it will start checking\nthe speed of your vehicle and play a single beep sound when exceeding 50km/h."),(0,o.kt)("div",{parentName:"li",className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"The ",(0,o.kt)("inlineCode",{parentName:"p"},"query")," handler with a ",(0,o.kt)("inlineCode",{parentName:"p"},"SPEED")," argument is only valid for some vehicles, mostly internal\ncombustion engine (ICE) vehicles. If you have an electric vehicle, you might need to use a more\nsophisticated setup to get the current speed of your vehicle. We suggest that you browse forums\nfor your make and model for such information."))),(0,o.kt)("div",{parentName:"li",className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Not Working?")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Check the log file on the device to see if there are warnings and/or errors. Check\n",(0,o.kt)("a",{parentName:"p",href:"/guides/autopi-logs"},"this")," guide out for more information on how to retrieve the logs from your\ndevice."))))),(0,o.kt)("h2",{id:"want-an-event-instead-of-a-beep"},"Want an Event Instead of a Beep?"),(0,o.kt)("p",null,"You can freely fire events from your custom code modules. If you're looking to execute\none or multiple different actions based on some event (in this case, speeding over 50km/h), you\nare able to do that. Let's add another function to the ",(0,o.kt)("em",{parentName:"p"},"my_triggers")," custom code:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'def speed_warning_event(result):\n    """\n    Trigger that will fire a \'vehicle/speeding\' event when vehicle speed exceeds value of 50.\n    """\n\n    # Check for error result\n    error = extract_error_from(result)\n    if error:\n        log.warning("Speed warning event trigger got error result: {:}".format(result))\n\n        return\n\n    # Check if speed value is above threshold\n    if result.get("value", 0) >= 50:\n\n        # Only play sound when threshold value is exceeded\n        if not __context__.get("speed_warning_event", False):\n            __salt__["event.fire"]({}, "vehicle/speeding")\n\n            # Set flag in context\n            __context__["speed_warning_event"] = True\n\n    # Speed value is below threshold\n    else:\n\n        # Reset flag in context\n        __context__["speed_warning_event"] = False\n')),(0,o.kt)("p",null,"The code here is esentially the same as the one presented above. The only difference is that\nthe AutoPi will fire an event internally instead of playing a beeping sound. This event can then\nbe used in the ",(0,o.kt)("strong",{parentName:"p"},"event_reactor")," service to perform other actions. Also, the event will be uploaded\nto the cloud and be visible from ",(0,o.kt)("strong",{parentName:"p"},"Advanced")," > ",(0,o.kt)("strong",{parentName:"p"},"Events"),"."),(0,o.kt)(i.$,{title:"Write custom trigger to play beep sound when speeding",url:"https://community.autopi.io/t/custom-code-write-custom-trigger-to-play-beep-sound-when-speeding/1566",mdxType:"Discussion"}))}m.isMDXComponent=!0},1743:function(e,t,n){"use strict";t.Z=n.p+"assets/images/creating_a_custom_hook-ab87a52463b37acac9197257231939b2.png"},1115:function(e,t,n){"use strict";t.Z=n.p+"assets/images/creating_a_new_worker-02fb00d769f8df1eb42bb49d2e40ca43.png"},9744:function(e,t,n){"use strict";t.Z=n.p+"assets/images/editing_custom_code-cf96ebb321a7da3ce07aaf3bcf3c8732.png"}}]);