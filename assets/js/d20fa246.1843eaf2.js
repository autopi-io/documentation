"use strict";(self.webpackChunkdocumentation_2=self.webpackChunkdocumentation_2||[]).push([[36],{14476:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/editing_custom_code-d819c216546e35a83749e7bab7ebd932.png"},28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>a});var r=t(96540);const i={},o=r.createContext(i);function s(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(o.Provider,{value:n},e.children)}},47886:(e,n,t)=>{t.d(n,{A:()=>o});t(96540);var r=t(74848);const i={mini:{name:"Mini",image:"/img/hardware/autopi_mini/AutoPi_Mini_5_Top_right.png"},cm4:{name:"TMU CM4",image:"/img/hardware/autopi_tmu_cm4/TMU_Floating_Topside_V1_scaled.png"},pro:{name:"CAN-FD Pro",image:"/img/hardware/autopi_canfd_pro/canfd_pro_trans.png"}};function o(e){let{supported:n}=e;return n?.length?(0,r.jsxs)("div",{style:{padding:"1rem",marginBottom:"1.5rem"},children:[(0,r.jsx)("strong",{children:"This guide is applicable to the following device/ devices:"}),(0,r.jsx)("div",{style:{display:"flex",gap:"1.5rem",marginTop:"0.5rem"},children:n.map((e=>{const n=i[e];return(0,r.jsxs)("div",{style:{textAlign:"center"},children:[(0,r.jsx)("img",{src:n.image,alt:n.name,style:{height:"60px",marginBottom:"0.25rem"}}),(0,r.jsx)("div",{children:n.name})]},e)}))})]}):null}},49545:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/creating_a_new_worker-148dc9dea13a75d21d3614e4ba659c6c.png"},58162:(e,n,t)=>{t.d(n,{A:()=>s});t(96540);const r="homeGrid_MM9h",i="cardGrid_IPp8";var o=t(74848);const s=e=>{let{children:n,home:t=!1}=e;return(0,o.jsx)("div",{className:t?r:i,children:n})}},75665:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/creating_a_custom_hook-d46892c875ff4041a989847d704bff54.png"},88495:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>g,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"cloud/device_management/services/create-custom-triggers","title":"Create Custom Triggers","description":"---","source":"@site/docs/cloud/device_management/services/create_custom_triggers.md","sourceDirName":"cloud/device_management/services","slug":"/cloud/device_management/services/create-custom-triggers","permalink":"/cloud/device_management/services/create-custom-triggers","draft":false,"unlisted":false,"editUrl":"https://github.com/autopi-io/documentation/edit/master/docs/cloud/device_management/services/create_custom_triggers.md","tags":[],"version":"current","frontMatter":{"id":"create-custom-triggers","title":"Create Custom Triggers","supportedDevices":["cm4","pro"]},"sidebar":"sidebar","previous":{"title":"Create Custom Services","permalink":"/cloud/device_management/services/create-custom-services"},"next":{"title":"Create Custom Workers","permalink":"/cloud/device_management/services/create-custom-workers"}}');var i=t(74848),o=t(28453),s=(t(58162),t(47886));const a={id:"create-custom-triggers",title:"Create Custom Triggers",supportedDevices:["cm4","pro"]},c=void 0,d={},l=[{value:"Want an Event Instead of a Beep?",id:"want-an-event-instead-of-a-beep",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.A,{supported:a.supportedDevices}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.p,{children:["In this guide we will explore how you can create a custom trigger for your ",(0,i.jsx)(n.a,{href:"https://www.autopi.io",children:"AutoPi"})," service. The\nexample that we will look at is a trigger that will play a beeping sound when the vehicle's speed\nis 50km/h or more. Let's dive straight in."]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["Service triggers are not to be confused with ",(0,i.jsx)(n.a,{href:"https://www.autopi.io/software-platform/cloud-management",children:"Cloud"})," triggers. Although they have the same name\nthey have two very different functions. Service triggers work ",(0,i.jsx)(n.strong,{children:"on the device"})," and can respond to\ndata coming in from a handler in various ways (emiting events, playing audio, etc). ",(0,i.jsx)(n.a,{href:"https://www.autopi.io/software-platform/cloud-management",children:"Cloud"})," trigers\non the other hand respond to events emited by the device ",(0,i.jsx)(n.strong,{children:"on the server side"}),"."]})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Let's start by creating a custom code module with the name ",(0,i.jsx)(n.em,{children:"my_triggers"})," of type ",(0,i.jsx)(n.em,{children:"Execution"}),". We\ncan do that by going over to ",(0,i.jsx)(n.strong,{children:"Device"})," > ",(0,i.jsx)(n.strong,{children:"Custom Code"}),":"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Editing custom code",src:t(14476).A+"",width:"1482",height:"1182"})}),"\n",(0,i.jsx)(n.p,{children:"Here is the code in plain text for easy copy and paste:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import logging\n\nfrom messaging import extract_error_from\n\nlog = logging.getLogger(__name__)\n\ndef speed_warning_beep(result):\n    """\n    Trigger that will play a warning beep sound when vehicle speed exceeds value of 50.\n    """\n\n    # Check for error result\n    error = extract_error_from(result)\n    if error:\n        log.warning("Speed warning beep trigger got error result: {:}".format(result))\n\n        return\n\n    # Check if speed value is above threshold\n    if result.get("value", 0) >= 50:\n\n        # Only play sound when threshold value is exceeded\n        if not __context__.get("speed_warning_beep", False):\n            __salt__["cmd.run"]("aplay /opt/autopi/audio/sound/beep.wav")\n\n            # Set flag in context\n            __context__["speed_warning_beep"] = True\n\n    # Speed value is below threshold\n    else:\n\n        # Reset flag in context\n        __context__["speed_warning_beep"] = False\n'})}),"\n",(0,i.jsxs)(n.p,{children:["To quickly run through the code, this code creates a function that will check if the result\npassed to it has a ",(0,i.jsx)(n.code,{children:"value"})," key that is equal to or more than 50. Once that condition is met, it\nwill make sure that the vehicle isn't already in that state through the context (if the vehicle\nis continuously above 50km/h we won't play the beeping sound continuously) and if it isn't it'll\nplay the beeping sound. Once the above or equal to condition is no longer met, we reset the\ncontext."]}),"\n",(0,i.jsxs)(n.p,{children:["Now, let's synchronise the changes to the device by clicking the ",(0,i.jsx)(n.strong,{children:"Sync"})," button. If the device\nis offline the changes will automatically be synchronised on next start-up."]}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsxs)(n.li,{children:["Next, we need to register that trigger in the service that it'll be used. For this guide, we\nneed to register it in the OBD service named ",(0,i.jsx)(n.strong,{children:"obd_manager"}),". Go to ",(0,i.jsx)(n.strong,{children:"Device"})," > ",(0,i.jsx)(n.strong,{children:"Services"})," >\n",(0,i.jsx)(n.strong,{children:"obd_manager"})," > ",(0,i.jsx)(n.strong,{children:"Hooks"})," > ",(0,i.jsx)(n.strong,{children:"Create"}),":"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Creating a custom hook",src:t(75665).A+"",width:"1476",height:"627"})}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsxs)(n.li,{children:["We now need to use the newly registered trigger hook by adding it to a workflow in a worker.\nGo to ",(0,i.jsx)(n.strong,{children:"Device"})," > ",(0,i.jsx)(n.strong,{children:"Services"})," > ",(0,i.jsx)(n.strong,{children:"obd_manager"})," > ",(0,i.jsx)(n.strong,{children:"Workers"})," > ",(0,i.jsx)(n.strong,{children:"Create"}),":"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Creating a new worker",src:t(49545).A+"",width:"1476",height:"860"})}),"\n",(0,i.jsx)(n.p,{children:"When the above changes have been successfully synchronised to your device, it will start checking\nthe speed of your vehicle and play a single beep sound when exceeding 50km/h."}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"query"})," handler with a ",(0,i.jsx)(n.code,{children:"SPEED"})," argument is only valid for some vehicles, mostly internal\ncombustion engine (ICE) vehicles. If you have an electric vehicle, you might need to use a more\nsophisticated setup to get the current speed of your vehicle. We suggest that you browse forums\nfor your make and model for such information."]})}),"\n",(0,i.jsx)(n.admonition,{title:"Not Working?",type:"tip",children:(0,i.jsxs)(n.p,{children:["Check the log file on the device to see if there are warnings and/or errors. Check\n",(0,i.jsx)(n.a,{href:"/developer_guides/autopi-logs",children:"this"})," guide out for more information on how to retrieve the logs from your\ndevice."]})}),"\n",(0,i.jsx)(n.h2,{id:"want-an-event-instead-of-a-beep",children:"Want an Event Instead of a Beep?"}),"\n",(0,i.jsxs)(n.p,{children:["You can freely fire events from your custom code modules. If you're looking to execute\none or multiple different actions based on some event (in this case, speeding over 50km/h), you\nare able to do that. Let's add another function to the ",(0,i.jsx)(n.em,{children:"my_triggers"})," custom code:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'def speed_warning_event(result):\n    """\n    Trigger that will fire a \'vehicle/speeding\' event when vehicle speed exceeds value of 50.\n    """\n\n    # Check for error result\n    error = extract_error_from(result)\n    if error:\n        log.warning("Speed warning event trigger got error result: {:}".format(result))\n\n        return\n\n    # Check if speed value is above threshold\n    if result.get("value", 0) >= 50:\n\n        # Only play sound when threshold value is exceeded\n        if not __context__.get("speed_warning_event", False):\n            __salt__["event.fire"]({}, "vehicle/speeding")\n\n            # Set flag in context\n            __context__["speed_warning_event"] = True\n\n    # Speed value is below threshold\n    else:\n\n        # Reset flag in context\n        __context__["speed_warning_event"] = False\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The code here is esentially the same as the one presented above. The only difference is that\nthe ",(0,i.jsx)(n.a,{href:"https://www.autopi.io",children:"AutoPi"})," will fire an event internally instead of playing a beeping sound. This event can then\nbe used in the ",(0,i.jsx)(n.strong,{children:"event_reactor"})," service to perform other actions. Also, the event will be uploaded\nto the ",(0,i.jsx)(n.a,{href:"https://www.autopi.io/software-platform/cloud-management",children:"Cloud"})," and be visible from ",(0,i.jsx)(n.strong,{children:"Device"})," > ",(0,i.jsx)(n.strong,{children:"Events"}),"."]})]})}function g(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}}}]);