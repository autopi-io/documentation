"use strict";(self.webpackChunkdocumentation_2=self.webpackChunkdocumentation_2||[]).push([[2722],{20837:(e,n,t)=>{t.d(n,{A:()=>s});const s="data:image/png;base64,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"},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>c});var s=t(96540);const o={},i=s.createContext(o);function r(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),s.createElement(i.Provider,{value:n},e.children)}},58162:(e,n,t)=>{t.d(n,{A:()=>r});t(96540);const s="homeGrid_MM9h",o="cardGrid_IPp8";var i=t(74848);const r=e=>{let{children:n,home:t=!1}=e;return(0,i.jsx)("div",{className:t?s:o,children:n})}},71180:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/passing_settings_to_custom_service-f5aa0933d7eb0eac98a3952d2b349d47.png"},79239:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>g,frontMatter:()=>r,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"cloud/device_management/services/create-custom-services","title":"Create Custom Services","description":"Sometimes, the pre-defined services won\'t implement the functionality that you\'re looking to have","source":"@site/docs/cloud/device_management/services/create_custom_services.md","sourceDirName":"cloud/device_management/services","slug":"/cloud/device_management/services/create-custom-services","permalink":"/cloud/device_management/services/create-custom-services","draft":false,"unlisted":false,"editUrl":"https://github.com/autopi-io/documentation/edit/master/docs/cloud/device_management/services/create_custom_services.md","tags":[],"version":"current","frontMatter":{"id":"create-custom-services","title":"Create Custom Services"},"sidebar":"sidebar","previous":{"title":"Create Custom Returners","permalink":"/cloud/device_management/services/create-custom-returners"},"next":{"title":"Create Custom Triggers","permalink":"/cloud/device_management/services/create-custom-triggers"}}');var o=t(74848),i=t(28453);t(58162);const r={id:"create-custom-services",title:"Create Custom Services"},c=void 0,l={},a=[{value:"Creating a Custom Service",id:"creating-a-custom-service",level:2},{value:"PIP Requirements",id:"pip-requirements",level:2},{value:"Pass Settings Into the Service.",id:"pass-settings-into-the-service",level:2},{value:"A Few Examples",id:"a-few-examples",level:2},{value:"Log Hello World Every 5 Seconds",id:"log-hello-world-every-5-seconds",level:3},{value:"Basic Service With Support for Configuring Workers From the Cloud Interface and Reporting of Failures Via Events.",id:"basic-service-with-support-for-configuring-workers-from-the-cloud-interface-and-reporting-of-failures-via-events",level:3},{value:"Listen to MQTT Topics",id:"listen-to-mqtt-topics",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["Sometimes, the pre-defined services won't implement the functionality that you're looking to have\nin your ",(0,o.jsx)(n.a,{href:"https://www.autopi.io",children:"AutoPi"}),". It is possible to create custom services that run on the device alongside the rest\nof ",(0,o.jsx)(n.a,{href:"https://www.autopi.io",children:"AutoPi"}),"'s services. This guide will explore how to do that."]}),"\n",(0,o.jsx)(n.h2,{id:"creating-a-custom-service",children:"Creating a Custom Service"}),"\n",(0,o.jsx)(n.admonition,{type:"note",children:(0,o.jsx)(n.p,{children:"Make sure that your device is updated, as that will otherwise prevent you from syncing the\nmodules."})}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Go to the ",(0,o.jsx)(n.strong,{children:"Services"})," section and click ",(0,o.jsx)(n.strong,{children:"Create"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Fill out the fields, and click ",(0,o.jsx)(n.strong,{children:"save"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"The service along with a custom module has now been created."}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Now you can navigate to the custom module and change the code.\n",(0,o.jsx)(n.strong,{children:"See examples below"})]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Now sync the changes by clicking the sync button or restarting the device which automatically pulls the changes."}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"When asked if you want to restart the salt-minion process, you should click yes, as the service\nis not loaded until the process has been restarted. You can also restart the minion process by\nrunning the following commands:"}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"# In web terminal\n$ minionutil.restart\n\n# In SSH terminal\n$ systemctl restart salt-minion\n"})}),"\n",(0,o.jsx)(n.h2,{id:"pip-requirements",children:"PIP Requirements"}),"\n",(0,o.jsx)(n.p,{children:"You can add PIP requirements to custom code modules like so:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Adding PIP requirements",src:t(20837).A+"",width:"508",height:"143"})}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsx)(n.p,{children:"You must follow the default python requirements.txt convention to define your PIP requirements."})}),"\n",(0,o.jsx)(n.h2,{id:"pass-settings-into-the-service",children:"Pass Settings Into the Service."}),"\n",(0,o.jsxs)(n.p,{children:["To pass settings into the service, you should set the settings field to a ",(0,o.jsx)(n.em,{children:"valid"})," JSON object."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Passing settings to custom service",src:t(71180).A+"",width:"1609",height:"919"})}),"\n",(0,o.jsx)(n.p,{children:"Which can then be accessed inside the service like so:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'some_setting = settings.get("some_setting", "default_value")\n'})}),"\n",(0,o.jsx)(n.h2,{id:"a-few-examples",children:"A Few Examples"}),"\n",(0,o.jsx)(n.h3,{id:"log-hello-world-every-5-seconds",children:"Log Hello World Every 5 Seconds"}),"\n",(0,o.jsx)(n.p,{children:'Let\'s try creating a service that simply outputs "Hello World" to the log every 5 seconds.'}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'import logging\nimport time\n\nlog = logging.getLogger(__name__)\n\ndef start(**settings):\n    try:\n        log.info("Starting SERVICE with settings: {:}".format(settings))\n\n        while True:\n            log.info(\'HELLO WORLD, anything new in the last 5 seconds?\')\n            time.sleep(5)\n\n    except Exception:\n        log.exception("Failed to start SERVICE")\n\n        raise\n    finally:\n        log.info("Stopping SERVICE")\n\n        # Stop everything, close connections etc.\n'})}),"\n",(0,o.jsxs)(n.p,{children:["And if you have ",(0,o.jsx)(n.code,{children:"info"})," level debugging configured on your device, you should now see it logging\n'HELLO WORLD' every 5 seconds."]}),"\n",(0,o.jsx)(n.admonition,{type:"note",children:(0,o.jsxs)(n.p,{children:["The log level of the device can be changed from the advanced settings, under ",(0,o.jsx)(n.strong,{children:"System"})," >\n",(0,o.jsx)(n.strong,{children:"Logging level"})]})}),"\n",(0,o.jsxs)(n.h3,{id:"basic-service-with-support-for-configuring-workers-from-the-cloud-interface-and-reporting-of-failures-via-events",children:["Basic Service With Support for Configuring Workers From the ",(0,o.jsx)(n.a,{href:"https://www.autopi.io/software-platform/cloud-management",children:"Cloud"})," Interface and Reporting of Failures Via Events."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'import logging\nimport time\n\nfrom common_util import factory_rendering\nfrom messaging import EventDrivenMessageProcessor\n\nlog = logging.getLogger(__name__)\n\ncontext = {\n}\n\nedmp = EventDrivenMessageProcessor("custom_service", context=context)\n\n@factory_rendering\ndef start(**settings):\n    try:\n        log.info("Starting custom manager")\n\n        context["settings"] = settings\n\n        # Init the message processor\n        edmp.init(__salt__, __opts__,\n            hooks=settings.get("hooks", []),\n            workers=settings.get("workers", []),\n            reactors=settings.get("reactors", []))\n        edmp.run()\n\n        # Initialize stuff here\n    \n    except Exception as ex:\n        log.exception("Failed to start custom manager")\n\n        if settings.get("trigger_events", True):\n            try:\n                edmp.trigger_event({\n                    "reason": str(ex),\n                }, "system/service/{:}/failed".format(__name__.split(".")[-1]))\n            except:\n                log.exception("Unable to trigger service failed event")\n\n        restart_delay = settings.get("restart_delay", 1)\n        if restart_delay:\n            log.info("Enforcing restart delay of {:} second(s)...".format(restart_delay))\n            time.sleep(restart_delay)\n\n        raise\n\n    finally:\n        log.info("Stopping custom manager")\n        # Clean up\n'})}),"\n",(0,o.jsx)(n.h3,{id:"listen-to-mqtt-topics",children:"Listen to MQTT Topics"}),"\n",(0,o.jsx)(n.p,{children:"This service will subscribe to all topics and log the messages. Remember to add the following PIP\nrequirements to the module:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"paho-mqtt==1.5.0\n"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Code"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'import logging\nimport paho.mqtt.client as mqtt\n\nlog = logging.getLogger(__name__)\n\nconnect_results = {\n    0: "Connection accepted",\n    1: "The Server does not support the level of the MQTT protocol requested by the Client",\n    2: "The Client identifier is correct UTF-8 but not allowed by the Server",\n    3: "The Network Connection has been made but the MQTT service is unavailable",\n    4: "The data in the user name or password is malformed",\n    5: "The Client is not authorized to connect",\n}\n\ndef on_message(mqttc, obj, msg):\n    log.info(msg.topic + " " + str(msg.qos) + " " + str(msg.payload))\n\ndef on_subscribe(mqttc, obj, mid, granted_qos):\n    log.info("Subscribed: " + str(mid) + " " + str(granted_qos))\n\ndef on_log(mqttc, obj, level, string):\n    log.info(string)\n\ndef on_connect(mqttc, obj, flags, rc):\n    result = "{:}: {:}".format(rc, connect_results.get(rc, "Unknown result code"))    \n    if rc == 0:\n        log.info(result)\n    else:\n        raise Exception(result)\n\n    try:\n        mqttc.subscribe("#", qos) # Subscribes to all topics.\n    except Exception as ex:\n        log.exception("Exception occurred when setting up registers")\n\n# glocal settings\nqos = 0\n\ndef start(**settings):\n    global qos\n\n    usetls = True\n    tlsVersion = None # will use most recent version\n    cacerts = None\n\n    port = 8883\n    host = ""\n    username = "username"\n    password = "password"\n\n    debug = False\n    keepalive = 60\n\n    # Setup\n    mqttc = mqtt.Client(None, clean_session=True)\n    if usetls:\n        mqttc.tls_set(ca_certs=cacerts, certfile=None, keyfile=None, cert_reqs=ssl.CERT_REQUIRED, tls_version=tlsVersion)\n    mqttc.username_pw_set(username, password)\n\n    mqttc.on_message = on_message\n    mqttc.on_connect = on_connect\n    mqttc.on_subscribe = on_subscribe\n\n    if debug:\n        mqttc.on_log = on_log\n\n    try:\n        log.info("Starting MQTT engine")\n\n        log.info("Connecting to {:} port: {:}".format(host, port))\n        mqttc.connect(host, port, keepalive)\n        mqttc.loop_forever(retry_first_connection=True)\n\n    except Exception:\n        log.exception("Failed to start MQTT engine")\n\n        raise\n    finally:\n        log.info("Stopping MQTT engine")\n        mqttc.disconnect()\n'})}),"\n",(0,o.jsx)(n.p,{children:"Further inspiration on how to write custom services (or engines as they are also called):"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://docs.saltstack.com/en/2017.7/topics/engines/index.html",children:"Salt documentation"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/autopi-io/autopi-core/tree/master/src/salt/base/ext/_engines",children:"Examples AutoPi.io on Github"})}),"\n"]})]})}function g(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}}}]);