(self.webpackChunkdocumentation_2=self.webpackChunkdocumentation_2||[]).push([[8989],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return d},kt:function(){return h}});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),c=p(n),h=i,m=c["".concat(l,".").concat(h)]||c[h]||u[h]||r;return n?a.createElement(m,o(o({ref:t},d),{},{components:n})):a.createElement(m,o({ref:t},d))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},51623:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return p},toc:function(){return d},default:function(){return c}});var a=n(22122),i=n(19756),r=(n(67294),n(3905)),o=["components"],s={id:"automatic-exports",title:"Automatic Exports"},l="Automatic Exporting",p={unversionedId:"cloud/fleet_management/vehicles/trips/automatic-exports",id:"cloud/fleet_management/vehicles/trips/automatic-exports",isDocsHomePage:!1,title:"Automatic Exports",description:"When enabled for a device, it will automatically trigger exports when a trip ends, and when an export is finished, it will send notifications (mail and/or JSON Http request)",source:"@site/docs/cloud/fleet_management/vehicles/trips/automatic-trip-exports.md",sourceDirName:"cloud/fleet_management/vehicles/trips",slug:"/cloud/fleet_management/vehicles/trips/automatic-exports",permalink:"/cloud/fleet_management/vehicles/trips/automatic-exports",editUrl:"https://github.com/autopi-io/documentation/edit/master/docs/cloud/fleet_management/vehicles/trips/automatic-trip-exports.md",tags:[],version:"current",frontMatter:{id:"automatic-exports",title:"Automatic Exports"},sidebar:"sidebar",previous:{title:"Introduction",permalink:"/cloud/fleet_management/vehicles/trips/introduction"},next:{title:"Locations",permalink:"/cloud/fleet_management/locations"}},d=[{value:"Endpoints Overview",id:"endpoints-overview",children:[]},{value:"How to Enable the Automatic Trip Export Functionality",id:"how-to-enable-the-automatic-trip-export-functionality",children:[]},{value:"Overview - Step by Step",id:"overview---step-by-step",children:[]},{value:"Authentication",id:"authentication",children:[]},{value:"Data Structure",id:"data-structure",children:[]},{value:"Manually Executing Trip Export Task",id:"manually-executing-trip-export-task",children:[]},{value:"Manually Retrieving Trip Export Task Results",id:"manually-retrieving-trip-export-task-results",children:[]}],u={toc:d};function c(e){var t=e.components,n=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"automatic-exporting"},"Automatic Exporting"),(0,r.kt)("p",null,"When enabled for a device, it will automatically trigger exports when a trip ends, and when an export is finished, it will send notifications (mail and/or JSON Http request)"),(0,r.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Contact ",(0,r.kt)("a",{parentName:"p",href:"mailto:sales@autopi.io"},"sales@autopi.io")," to get more information."))),(0,r.kt)("h2",{id:"endpoints-overview"},"Endpoints Overview"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"GET tasks/"),"\nReturns all tasks for the current customer"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"GET tasks/{task_id}/result/")," Downloads the exported data from the task"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"GET tasks/{task_id}/remove_result/")," Removed the exported data"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"GET logbook/trips/?device=device_id")," Returns all trips for the specific device. (device querystring can be omitted, to show all trips for customer)")),(0,r.kt)("h2",{id:"how-to-enable-the-automatic-trip-export-functionality"},"How to Enable the Automatic Trip Export Functionality"),(0,r.kt)("p",null,"The setting should be enabled per device, and this is done in Device > Advanced Settings > Trip > Auto Export\nThis can also be managed automatically for the entire fleet by using a template."),(0,r.kt)("h2",{id:"overview---step-by-step"},"Overview - Step by Step"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The device sends an event that causes the server to trigger the trip_end event.\nThis can be configured in the advanced settings.\nBy default trips are started on an ",(0,r.kt)("inlineCode",{parentName:"p"},"vehicle/engine/running")," event and stopped on ",(0,r.kt)("inlineCode",{parentName:"p"},"vehicle/engine/not_running|stopped")," event.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"This trip_end event causes a trip export to be scheduled, and will execute the export after the configured trip reopen limit, which by default is set to 10 minutes (600 seconds). This is because we need to make sure that all data from the device has been uploaded properly, before the export is executed.\nThe minimum time it will wait to do the trip export after a trip ends, is 10 minutes.\nThis means that even if the trip reopen limit is set to 1 second, the export will not run untill after 10 minutes."),(0,r.kt)("p",{parentName:"li"},"It also means that if a trip is reopened a number of times, it can execute multiple exports, each one overwriting the last.\nIt will not schedule a new export if another is already running."),(0,r.kt)("p",{parentName:"li"},"Read more about how trips works ",(0,r.kt)("a",{parentName:"p",href:"/cloud/fleet_management/vehicles/trips/introduction"},"here"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"When a trip export is scheduled, you can see the status with the tasks endpoint ",(0,r.kt)("inlineCode",{parentName:"p"},"tasks/"),"\nWhere you can also see the ID and the trip ID of the trip being exported."),(0,r.kt)("p",{parentName:"li"},"It will only ever create one task per trip, ie. the list of tasks is one-to-one with trips."),(0,r.kt)("p",{parentName:"li"},"An export of a trip with the default set of logging should take only a few seconds, it of course depends on how long the trip is, and how much data is logged, as that will change the export time taken considerably.\nBut we are still talking seconds or minutes as it should for example, be able to export 10000 logged datapoints ever 400ms or so.\nSo a trip with 1mio datapoints should take roughly 40 seconds.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"When the trip export finishes, it will send a signal to any listening triggers, which can be configured to send an email and/or a JSON payload. They are configured on the triggers page on the frontend on the ",(0,r.kt)("inlineCode",{parentName:"p"},"Triggers")," page.\nThe trigger type must be set to ",(0,r.kt)("inlineCode",{parentName:"p"},"signal")," type, and it must target the signal ",(0,r.kt)("inlineCode",{parentName:"p"},"trip_export_finished"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The exported data package can be downloaded by calling the ",(0,r.kt)("inlineCode",{parentName:"p"},"tasks/ID/result/")," endpoint, which will return the file ",(0,r.kt)("inlineCode",{parentName:"p"},"TRIP_ID.json.gz")," containing the exported data. After you have downloaded the exported data, you must remove the exported result by calling the endpoint ",(0,r.kt)("inlineCode",{parentName:"p"},"tasks/ID/clear_result/"),"\nThis is done to prevent the system from re-broadcasting that the export is ready for download, as this is done once a day for all exports older than 2 hours, the reason for this is that if the webhook request is somehow missed, it will still get picked up later."))),(0,r.kt)("h2",{id:"authentication"},"Authentication"),(0,r.kt)("p",null,"It's possible to access the API with a pre-generated API token, so that you will not have to authenticate and cache the JWT token as used when logging in to the frontend.\nTo use this new API token, simply set the following header on the request."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-http"},"Authorization: APIToken TOKEN\n")),(0,r.kt)("h2",{id:"data-structure"},"Data Structure"),(0,r.kt)("p",null,"The trip + any uploaded data is exported as json lines - this means that every line has a valid json object, see more here: ",(0,r.kt)("a",{parentName:"p",href:"http://jsonlines.org/"},"http://jsonlines.org/")),(0,r.kt)("p",null,"The data is sorted in ascending order.\nThe exported file is gzipped, so it must be unpacked before it can be interpreted as json."),(0,r.kt)("p",null,"The structure is as follows.\nThe first item is the trip object, and the next item(s) is all the data logged during that trip."),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{"id": "TRIP_UUID", "start_time_utc": "2020-01-01T08:16:52.962918Z", "end_time_utc": "2020-01-01T08:22:00.942395Z", "start_position_lat":  "56.144...", .... }\n\n{"@vid": VEHICLE_ID, "@uid": "DEVICE_UNIT_ID", "@ts": "2020-01-01T08:16:52.962918Z", "@tag": "vehicle/engine/running", "@t": "event.vehicle.engine", "@rec": "2020-01-01T08:17:56.128398Z"}\n\n{"obd.rpm.unit": "revolutions_per_minute", "@vid": VEHICLE_ID, "@uid": "DEVICE_UNIT_ID", "obd.rpm.value": 830.5, "@ts": "2020-01-01T08:16:53.001449Z", "@t": "obd.rpm", "@rec": "2020-01-01T08:17:56.128138Z"}\n\n{"@vid": VEHICLE_ID, "@uid": "DEVICE_UNIT_ID", "@ts": "2020-01-01T08:16:53.107849Z", "@t": "obd.coolant_temp", "obd.coolant_temp.value": 19, "obd.coolant_temp.unit": "degC", "@rec": "2020-01-01T08:17:56.128149Z"}\n')),(0,r.kt)("h2",{id:"manually-executing-trip-export-task"},"Manually Executing Trip Export Task"),(0,r.kt)("p",null,"After a while the trip export will no longer be present on the server, and if a new export is needed, you can re-run the export for an old trip, depending on the data retention conditions for the specific environment, using the ",(0,r.kt)("inlineCode",{parentName:"p"},"tasks")," endpoing like so."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"POST tasks/")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "task": "core.tasks.es_trip_export",\n    "args": [],\n    "kwargs": {\n        "trip_id": "TRIP_ID"\n    }\n}\n')),(0,r.kt)("p",null,"This will return a new task object, and using the task id you can retrieve the result using the above mentioned ",(0,r.kt)("inlineCode",{parentName:"p"},"tasks/ID/result/")," endpoint, when the task has completed."),(0,r.kt)("h2",{id:"manually-retrieving-trip-export-task-results"},"Manually Retrieving Trip Export Task Results"),(0,r.kt)("p",null,"To retrieve the exported data, you can retrieve a list of the tasks, and get the task ids from there."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"GET tasks/")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'[{\n    "id": 100,\n    "created_at": "2020-01-27T17:30:42.460311Z",\n    "task": "core.tasks.es_trip_export",\n    "args": [],\n    "kwargs": {\n        "trip_id": "00000000-0000-0000-0000-000000000000"\n    },\n    "state": "SUCCESS"\n}]\n')),(0,r.kt)("p",null,"In the response for each task you can see the task ID, and which trip ID it was executed for."),(0,r.kt)("p",null,"Now you can use the task ID to retrieve the result, in this case: 100"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"GET tasks/100/result/")))}c.isMDXComponent=!0}}]);