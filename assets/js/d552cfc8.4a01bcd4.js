"use strict";(self.webpackChunkdocumentation_2=self.webpackChunkdocumentation_2||[]).push([[5981],{28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>d});var i=t(96540);const r={},o=i.createContext(r);function s(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(o.Provider,{value:n},e.children)}},49399:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"developer_guides/setting-up-docker","title":"Setting Up Docker on Your Device","description":"Overview","source":"@site/docs/developer_guides/setting_up_docker.md","sourceDirName":"developer_guides","slug":"/developer_guides/setting-up-docker","permalink":"/developer_guides/setting-up-docker","draft":false,"unlisted":false,"editUrl":"https://github.com/autopi-io/documentation/edit/master/docs/developer_guides/setting_up_docker.md","tags":[],"version":"current","frontMatter":{"id":"setting-up-docker","title":"Setting Up Docker on Your Device"},"sidebar":"sidebar","previous":{"title":"AutoPi Logs","permalink":"/developer_guides/autopi-logs"},"next":{"title":"Using the AutoPi With an External Power Supply","permalink":"/developer_guides/using-the-autopi-with-an-external-power-supply"}}');var r=t(74848),o=t(28453);const s={id:"setting-up-docker",title:"Setting Up Docker on Your Device"},d=void 0,l={},a=[{value:"Overview",id:"overview",level:2},{value:"Deploying Docker Containers on Devices",id:"deploying-docker-containers-on-devices",level:3},{value:"Endpoints",id:"endpoints",level:2},{value:"Registry",id:"registry",level:3},{value:"Project",id:"project",level:3},{value:"Release",id:"release",level:3},{value:"Special Fields",id:"special-fields",level:4},{value:"Device",id:"device",level:3},{value:"Modules",id:"modules",level:2},{value:"Executing Module Commands",id:"executing-module-commands",level:3},{value:"Executing Commands Locally On the Device",id:"executing-commands-locally-on-the-device",level:4},{value:"Container Logs",id:"container-logs",level:3},{value:"Production Environment",id:"production-environment",level:2},{value:"REST API",id:"rest-api",level:3},{value:"Authenticate Using API Token",id:"authenticate-using-api-token",level:4},{value:"Telemetry Data Examples",id:"telemetry-data-examples",level:4},{value:"Logbook Storage Read Parameters",id:"logbook-storage-read-parameters",level:5}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(n.h3,{id:"deploying-docker-containers-on-devices",children:"Deploying Docker Containers on Devices"}),"\n",(0,r.jsx)(n.p,{children:"**1.\tCreate the release. **"}),"\n",(0,r.jsx)(n.p,{children:"The way this will work is that a Release endpoint will be implemented where each release will contain the following information"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Version"}),"\n",(0,r.jsx)(n.li,{children:"Which devices the release applies to"}),"\n",(0,r.jsxs)(n.li,{children:["A number of containers each with the following information","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Name"}),"\n",(0,r.jsx)(n.li,{children:"Which image+tag to run"}),"\n",(0,r.jsx)(n.li,{children:"Which tags should be present on the device"}),"\n",(0,r.jsx)(n.li,{children:"Startup parameters"}),"\n",(0,r.jsx)(n.li,{children:"If data directories should be purged on deploy."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This endpoint will return success when the release is created."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"2.\tThe update will then be queued on each referenced device."})}),"\n",(0,r.jsx)(n.p,{children:"This will cause the device to retrieve the active release associated to it, and perform the following actions."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Docker state flow",src:t(88686).A+"",width:"602",height:"840"})}),"\n",(0,r.jsx)(n.h2,{id:"endpoints",children:"Endpoints"}),"\n",(0,r.jsx)(n.p,{children:"The CRUD endpoints all return \u201c201 Created\u201d or \u201c200 OK\u201d when an entity is created or modified, and the body of the response will contain the created or modified entity.\nThe DELETE method will return \u201c204 No content\u201d on success."}),"\n",(0,r.jsx)(n.h3,{id:"registry",children:"Registry"}),"\n",(0,r.jsx)(n.p,{children:"A registry should be created to allow the device to authenticate against a custom docker registry.\nThe model contains the url and credentials for the custom docker registry.\nWhen added, devices will automatically log in to the registry if not already logged in, on startup, and thereby be ready to pull images."}),"\n",(0,r.jsx)(n.p,{children:"If the image should be pulled through a custom registry, the registry needs to be referenced when creating the container."}),"\n",(0,r.jsxs)(n.p,{children:["Creating a registry is done using this endpoint\n",(0,r.jsx)(n.a,{href:"https://api.autopi.io/#/docker/docker_registries_create",children:"https://api.autopi.io/#/docker/docker_registries_create"})]}),"\n",(0,r.jsx)(n.h3,{id:"project",children:"Project"}),"\n",(0,r.jsx)(n.p,{children:"The project endpoint is a wrapper for releases, so to create any releases you must first create a project."}),"\n",(0,r.jsx)(n.p,{children:"Creating a project is done using this endpoint"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"POST /docker/projects/\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://api.autopi.io/#/docker/docker_projects_create",children:"https://api.autopi.io/#/docker/docker_projects_create"})}),"\n",(0,r.jsx)(n.h3,{id:"release",children:"Release"}),"\n",(0,r.jsx)(n.p,{children:"The release endpoint is used to create new releases, and contains a list of containers each with metadata and runtime properties for that specific container."}),"\n",(0,r.jsx)(n.p,{children:"Creating a project is done using this nested endpoint"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"POST /docker/projects/{project_pk}/releases/\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://api.autopi.io/#/docker/docker_projects_releases_create",children:"https://api.autopi.io/#/docker/docker_projects_releases_create"})}),"\n",(0,r.jsx)(n.p,{children:"Payload"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'{\n   "id": 1,\n   "version": "1.0.0",\n   "version_hash": "96a7191f",\n   "devices": [\n       "device_id"\n   ],\n   "containers": [\n       {\n           "name": "curveball",\n           "image": "curveball",\n           "tag": "delta-base-r0.0.0.1",\n           "required_tags": [\n               "base"\n           ],\n           "startup_parameters": {\n               "environment": "REQUESTS_CA_BUNDLE=\'/usr/local/share/ca-certificates/AdamCA.crt\'",\n               "binds": [\n                   "/home/balenaEngine/data:/opt/RavenDB/Server/RavenData"\n               ],\n               "network_mode": "host",\n               "restart_policy": "always",\n               "privileged": true\n           },\n           "purge_data": false,\n           "registry": 1,\n           "fully_qualified_name": "deployment-curveball-1"\n       },\n       {\n           "name": "ravendb",\n           "image": "ravendb",\n           "tag": "base",\n           "required_tags": [],\n           "startup_parameters": {\n               "environment": "RAVEN_ARGS=\'--config-path /opt/RavenDB/Server/RavenData/settings.json\'",\n               "binds": [\n                   "/home/balenaEngine/data:/opt/RavenDB/Server/RavenData"\n               ],\n               "network_mode": "host",\n               "restart_policy": "always",\n               "privileged": true\n           },\n           "purge_data": false,\n           "registry": 1,\n           "fully_qualified_name": "deployment-ravendb-1"\n       }\n   ],\n   "successful_deployments": [\n       "device_id"\n   ],\n   "remove_containers": [\n       "curveball",\n       "ravendb"\n   ]\n}\n'})}),"\n",(0,r.jsx)(n.h4,{id:"special-fields",children:"Special Fields"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{style:{textAlign:"center"},children:(0,r.jsx)(n.strong,{children:"Name"})}),(0,r.jsx)(n.th,{children:(0,r.jsx)(n.strong,{children:"Required"})}),(0,r.jsx)(n.th,{children:(0,r.jsx)(n.strong,{children:"Description"})})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"remove_containers"}),(0,r.jsx)(n.td,{children:"No"}),(0,r.jsx)(n.td,{children:"Explicitly names the containers which should be handled as \u2018initial containers\u2019. On release it will attempt to stop each container, run deployment, and if successful the containers will be removed, or on failure, they will be restarted."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"version_hash"}),(0,r.jsx)(n.td,{children:"Readonly"}),(0,r.jsx)(n.td,{children:"Alternative autogenerated field (readonly) only used for referencing a release by a generated version."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"successful_deployments"}),(0,r.jsx)(n.td,{children:"Readonly"}),(0,r.jsx)(n.td,{children:"Will include only devices which has successfully deployed the release."})]})]})]}),"\n",(0,r.jsx)(n.p,{children:"After a release is created, each device associated to the release will receive the release information, and the release will be applied the next time the device is about to go to sleep, as the device in that situation is considered to be idle. Logging in to registries, removing images, pulling new images, starting containers etc."}),"\n",(0,r.jsx)(n.p,{children:"The release can also be triggered by executing the following command via the execute endpoint on the devices you want to deploy to."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"state.sls docker.release\n"})}),"\n",(0,r.jsx)(n.h3,{id:"device",children:"Device"}),"\n",(0,r.jsx)(n.p,{children:"The device endpoints can be used to retrieve either all devices, or some devices, and includes a new field called docker_releases which can be used to see if a specific release is deployed successfully on the device. The ID is the ID of the release."}),"\n",(0,r.jsxs)(n.p,{children:["Get a specific device\n",(0,r.jsx)(n.a,{href:"https://api.autopi.io/#/dongle/dongle_devices_read",children:"https://api.autopi.io/#/dongle/dongle_devices_read"})]}),"\n",(0,r.jsxs)(n.p,{children:["Get all devices\n",(0,r.jsx)(n.a,{href:"https://api.autopi.io/#/dongle/dongle_devices_list",children:"https://api.autopi.io/#/dongle/dongle_devices_list"})]}),"\n",(0,r.jsx)(n.p,{children:"Both endpoints returns device object(s)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'{\n  "id": "734c361a-ba56-472a-a891-ee2af1a8057v",\n  "unit_id": "4e633880-ef6e-4c20-77ed-5761b3de5d4c",\n  ...\n  "docker_releases": [\n\t103\n  ]\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u2003"}),"\n",(0,r.jsx)(n.h2,{id:"modules",children:"Modules"}),"\n",(0,r.jsx)(n.p,{children:"Highlighted modules for performing various actions on a running device docker instance."}),"\n",(0,r.jsx)(n.h3,{id:"executing-module-commands",children:"Executing Module Commands"}),"\n",(0,r.jsxs)(n.p,{children:["Module commands is executed on the device through the execute endpoint.\nSee documentation here: ",(0,r.jsx)(n.a,{href:"https://api.autopi.io/#/dongle/dongle_devices_execute_command",children:"https://api.autopi.io/#/dongle/dongle_devices_execute_command"})]}),"\n",(0,r.jsxs)(n.p,{children:["When executing commands remotely, you must execute the command async via the execute endpoint, and then use the ",(0,r.jsx)(n.a,{href:"https://api.autopi.io/#/dongle/dongle_devices_retrieve_command_result",children:"https://api.autopi.io/#/dongle/dongle_devices_retrieve_command_result"})," endpoint to poll for the result from the device."]}),"\n",(0,r.jsx)(n.p,{children:"Example payloads for REST API are included below."}),"\n",(0,r.jsx)(n.h4,{id:"executing-commands-locally-on-the-device",children:"Executing Commands Locally On the Device"}),"\n",(0,r.jsx)(n.p,{children:"The above commands can also be executed directly on the device with the following endpoint"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"POST localhost:9000/dongle/<uuid:unit_id>/execute/\n"})}),"\n",(0,r.jsx)(n.p,{children:"The body should be the same as the above remote command endpoint."}),"\n",(0,r.jsx)(n.p,{children:"The unit_id can be retrieved one of the following ways"}),"\n",(0,r.jsx)(n.p,{children:"A.\tCalling the root route"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"GET localhost:9000\n"})}),"\n",(0,r.jsx)(n.p,{children:"B.\tReading it from the file"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"/etc/salt/minion_id\n"})}),"\n",(0,r.jsx)(n.p,{children:"The reason that you need the unit_id is because we need to make sure that the request is actually meant for that specific device when using the endpoint from another connected device, like when using the local configuration tool."}),"\n",(0,r.jsx)(n.h3,{id:"container-logs",children:"Container Logs"}),"\n",(0,r.jsx)(n.p,{children:"Logs are retrieved from the containers by using the docker module."}),"\n",(0,r.jsx)(n.p,{children:"docker.logs CONTAINER_NAME"}),"\n",(0,r.jsx)(n.p,{children:"Example payload for executing via REST API"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'{\n  "command": "docker.logs",\n  "arg": [\n\t"CONTAINER_NAME"\n  ],\n  "kwarg": {}\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"5.3. Device Logs\nLogs are retrieved from the device by using the minionutil module."}),"\n",(0,r.jsx)(n.p,{children:"minionutil.last_logs"}),"\n",(0,r.jsxs)(n.p,{children:["See documentation site for all parameters\n",(0,r.jsx)(n.a,{href:"/core/commands/core-commands-minionutil/#minionutillast_logs",children:(0,r.jsx)(n.code,{children:"minionutil.last_logs"})})]}),"\n",(0,r.jsx)(n.p,{children:"Example payload for executing via REST API"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'{\n  "command": "minionutil.last_logs",\n  "arg": [],\n  "kwarg": {}\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"production-environment",children:"Production Environment"}),"\n",(0,r.jsx)(n.p,{children:"The production environment is located at: my.autopi.io"}),"\n",(0,r.jsx)(n.h3,{id:"rest-api",children:"REST API"}),"\n",(0,r.jsx)(n.p,{children:"The API can be accessed here api.autopi.io along with the API documentation."}),"\n",(0,r.jsx)(n.h4,{id:"authenticate-using-api-token",children:"Authenticate Using API Token"}),"\n",(0,r.jsx)(n.p,{children:"Authentication should be done with the API tokens.\nThese tokens can be generated in the account page. The expire date is optional.\nThe tokens can then be used in external systems to authenticate the requests.\nTo use the token, you simply set the Authorization header to the following value, when sending HTTP requests to the API."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Authorization: APIToken ******\n"})}),"\n",(0,r.jsx)(n.h4,{id:"telemetry-data-examples",children:"Telemetry Data Examples"}),"\n",(0,r.jsx)(n.p,{children:"Accessing data from a device is done by calling the logbook endpoint."}),"\n",(0,r.jsx)(n.h5,{id:"logbook-storage-read-parameters",children:"Logbook Storage Read Parameters"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"device_id:"})," ID of the device you want to retrieve data from.\n",(0,r.jsx)(n.strong,{children:"field:"})," Name of the field you want to retrieve the value from.\n",(0,r.jsx)(n.strong,{children:"field_type:"})," type of the field\n",(0,r.jsx)(n.strong,{children:"from_utc:"})," ISO Datetime string\n",(0,r.jsx)(n.strong,{children:"to_utc:"})," ISO Datetime string\n",(0,r.jsx)(n.strong,{children:"aggregation:"})," Aggregation method (AVG, MIN, MAX, SUM)\n",(0,r.jsx)(n.strong,{children:"interval:"})," Data is aggregated based on the aggregation method specified, the interval specifies how many groups the data is grouped into. For example, getting data for a 10 hour period, with the interval set to 1h, you will get back 10 values, one value per hour."]}),"\n",(0,r.jsx)(n.p,{children:"Getting positions"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"GET /logbook/storage/read/\n?device_id=DEVICE_ID\n&field=track.pos.loc\n&field_type=geo_point\n&from_utc=2020-01-01T00:00:00.000Z\n&to_utc=2020-01-01T01:00:00.000Z\n"})}),"\n",(0,r.jsx)(n.p,{children:"Example response"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'[\n\t{\n        \t"ts": "2020-07-09T10:11:53.811839Z",\n        \t"location": {\n                \t"lat": 57.04699,\n                \t"lon": 9.93909\n        \t}\n\t},\n\t{\n        \t"ts": "2020-07-09T10:11:59.248421Z",\n        \t"location": {\n                \t"lat": 57.04697,\n                \t"lon": 9.93808\n        \t}\n\t}\n]\n'})}),"\n",(0,r.jsx)(n.p,{children:"Battery Voltage readings"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"GET /logbook/storage/read/\n?device_id=DEVICE_ID\n&field=obd.bat.voltage\n&field_type=float\n&aggregation=avg\n&from_utc=2020-01-01T00:00:00.000Z\n&to_utc=2020-01-01T01:00:00.000Z\n&interval=10m\n"})}),"\n",(0,r.jsx)(n.p,{children:"Example response"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'[\n\t{\n    \t    "max_ts": 1594289021415,\n    \t    "ts": "2020-07-09T10:03:37.566Z",\n    \t    "value": 13.5\n\t},\n\t{\n    \t    "max_ts": 1594289026525,\n    \t    "ts": "2020-07-09T10:13:45.378Z",\n    \t    "value": 13.600000381469727\n\t}\n]\n'})})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},88686:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/docker_flow-deebcf7223260c08a16a4d49b48eb398.png"}}]);